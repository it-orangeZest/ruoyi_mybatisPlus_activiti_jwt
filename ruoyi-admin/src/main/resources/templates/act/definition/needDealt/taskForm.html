<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" xmlns:shiro="http://www.pollix.at/thymeleaf/shiro">
<head>
    <th:block th:include="include :: header('任务处理')" />
    <th:block th:include="include :: layout-latest-css" />
	<th:block th:include="include :: datetimepicker-css" />
	<th:block th:include="include :: select2-css" />
</head>
<body class="gray-bg">
	<div class="wrapper wrapper-content animated fadeInRight ibox-content" style="background-color: rgb(243, 243, 244);">
		<div class="tabs-container">
			<ul class="nav nav-tabs">
				<li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true"> 表单</a>
				</li>
				<li class=""><a data-toggle="tab" href="#tab-2" aria-expanded="false">审批历史</a>
				</li>
			</ul>
			<div class="tab-content">
				<div id="tab-1" class="tab-pane active">
					<div class="panel-body">
						<form class="m" id="form-instance-add">
							<!--<div class="form-group">
                                <label class="col-sm-3 control-label">请假类型：</label>
                                <div class="col-sm-8">
                                    <select name="type" class="form-control m-b" th:with="type=${@dict.getType('biz_leave_type')}">
                                        <option th:each="dict : ${type}" th:text="${dict.dictLabel}" th:value="${dict.dictValue}"></option>
                                    </select>
                                </div>
                            </div>-->
							<input id="task_id" type="hidden" name="taskId" th:value="${taskId}">
							<input id="form_key" type="hidden" name="formKey" th:value="${formKey}">
							<div id="task_form" th:utext="${content}"></div>

						</form>
					</div>
				</div>
				<div id="tab-2" class="tab-pane">
					<div class="panel-body">
						<iframe th:src="${'/act/processTask/goHisTasks/' + instanceId}" style="width: 100%; height: 500px; border: 0;"></iframe>
					</div>
				</div>
			</div>


		</div>
	</div>





















	</div>
<th:block th:include="include :: footer" />
<th:block th:include="include :: datetimepicker-js" />
<th:block th:include="include :: layout-latest-js" />
<th:block th:include="include :: select2-js" />
<script th:inline="javascript">
var editFlag = [[${@permission.hasPermi('system:role:edit')}]];
var removeFlag = [[${@permission.hasPermi('system:role:remove')}]];
var isBack = [[${isBack}]];
var prefix = ctx + "act/processTask";
function submitHandler() {

		$.operate.save(prefix + "/complete", $('#form-instance-add').serialize());

}

var laydate;

$(function(){
	initSelect2();
	initDatetime();
	if(isBack || isBack == "true"){
		initFormData();
	}
});

/**
 * 初始化select2组件
 */
function initSelect2(){
	$(".select2").remove();
	$(".drag-item select").removeClass("select2-hidden-accessible");
	$(".drag-item select option").removeAttr("data-select2-id");
	$(".drag-item select").select2();
}

/**
 * 初始化日期组件
 */
function initDatetime(){
	var arr = $(".drag-item");
	layui.use('laydate', function() {
		laydate = layui.laydate;
		for(var i=0 ; i<arr.length ; i++){
			var c = arr[i];
			if(c.dataset.type == "drag_datetime"){
				var reals = $(c).find(".real");
				for(var j=0 ; j<reals.length ; j++){
					laydate.render({
						elem: '#'+$(reals[j]).attr("id"),
						type: 'datetime',
						trigger: 'click'
					});
				}
			}
		}
	});
}

function initFormData() {
	let task_id = $("#task_id").val();
	$.ajax({
		url: "/act/processTask/historyTaskForm/"+task_id,
		post: "GET",
		success: function (res) {
			console.log(res);
			debugger;
			var variables = res.data;


				var taskDiv = $("#task_form");

				for (var j=0 ; j<variables.length ; j++){
					var currentVatiable = variables[j];
					var currentVatiableDiv = taskDiv.find("[name='"+currentVatiable.name+"']");
					if(currentVatiableDiv.length == 1){
						var localName = currentVatiableDiv[0].localName;
						if(localName == "select"){
							currentVatiableDiv.val(currentVatiable.value).trigger("change");
						}else{
							currentVatiableDiv.val(currentVatiable.value);
						}
					}

				}

		}
	})
}
</script>
</body>
</html>